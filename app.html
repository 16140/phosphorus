<!doctype html>
<meta charset=utf-8>
<meta name=viewport content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name=apple-mobile-web-app-capable content=yes>
<meta name=apple-mobile-web-app-status-bar-style content=black>
<title>phosphorus</title>
<link rel=stylesheet href=app.css>
<div class=player></div>
<div class=splash>
<div>
  <h1>phosphorus</h1>
  <div class=progress><div class=progress-bar></div></div>
</div>
</div>
<div class=error>
<div>
  <h1>phosphorus</h1>
  <p>An error has occurred. Please file a bug report on <a href=https://github.com/nathan/phosphorus/issues/new>GitHub</a></p>
</div>
</div>
<script src=//canvg.googlecode.com/svn/trunk/rgbcolor.js></script>
<script src=//canvg.googlecode.com/svn/trunk/StackBlur.js></script>
<script src=//canvg.googlecode.com/svn/trunk/canvg.js></script>
<script src=phosphorus.js></script>
<script>

(function () {
  'use strict';

  var stage;
  var isFullScreen = false;

  var prefix = 'http://scratch.mit.edu/projects/';
  var defaultId = '10000160';

  var projectId = defaultId;
  var turbo = false;

  var params = location.search.substr(1).split('&');
  params.forEach(function(p) {
    var parts = p.split('=');
    if (parts.length > 1) {
      switch (parts[0]) {
        case 'id':
          projectId = Number(parts[1]);
          break;
        case 'turbo':
          turbo = parts[1] !== 'false';
          break;
      }
    }
  });

  var splash = document.querySelector('.splash');
  var progressBar = document.querySelector('.progress-bar');
  var error = document.querySelector('.error');
  var player = document.querySelector('.player');

  var stage;

  var layout = function() {
    if (!stage) return;
    var w = Math.min(window.innerWidth, window.innerHeight / .75);
    var h = w * .75;
    player.style.left = (window.innerWidth - w) / 2 + 'px';
    player.style.top = (window.innerHeight - h) / 2 + 'px';
    stage.zoom = w / 480;
    stage.draw();
  };

  window.addEventListener('resize', layout);

  if (P.hasTouchEvents) {
    document.addEventListener('touchmove', function(e) {
      e.preventDefault();
    });
  }

  var request = P.IO.loadScratchr2Project(projectId);

  request.onload = function (s) {
    splash.style.display = 'none';

    stage = s;
    layout();

    s.isTurbo = turbo;
    s.start();
    s.triggerGreenFlag();
    s.focus();

    player.appendChild(s.canvas);
  };
  request.onerror = function (e) {
    error.style.display = 'table';
    console.error(e.stack);
  };
  request.onprogress = function (e) {
    progressBar.style.width = (10 + e.loaded / e.total * 90) + '%';
  };

  P.IO.load('http://scratch.mit.edu/projects/' + projectId + '/').onload = function(data) {
    var m = /<title>\s*(.+?)(\s+on\s+Scratch)?\s*<\/title>/.exec(data);
    if (m) {
      document.title = m[1];
    }
  };

}());

</script>
